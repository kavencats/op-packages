#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1
NAME=audit
PROG=/usr/bin/audit-daemon

AUDIT_CONFIG=/etc/config/audit

start_service() {
    local enabled=$(uci -q get audit.global.enabled)
    local log_level=$(uci -q get audit.global.log_level)
    
    [ "$enabled" = "1" ] || return 1
    
    procd_open_instance
    procd_set_param command "$PROG" -c "$AUDIT_CONFIG" -l "$log_level"
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    
    # Apply nftables rules for audit
    /usr/sbin/nft -f /etc/nftables.d/10-audit-rules.nft
}

stop_service() {
    # Remove audit nftables rules
    /usr/sbin/nft delete table inet audit 2>/dev/null || true
    killall audit-daemon 2>/dev/null || true
}

reload_service() {
    stop
    start
}