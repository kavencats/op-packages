<%+header%>

<div class="cbi-map" id="cbi-network-audit">
    <h2 name="content"><%:Network Audit Overview%></h2>
    
    <div class="cbi-map-descr">
        <p><%:Real-time network traffic auditing and monitoring.%></p>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:Service Status%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Service Status%>:</label>
            <div class="cbi-value-field">
                <span id="service-status" class="status-label">-</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Enabled%>:</label>
            <div class="cbi-value-field">
                <span id="service-enabled">-</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Version%>:</label>
            <div class="cbi-value-field">
                <span id="service-version">1.0.0</span>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:Quick Actions%></legend>
        <div class="cbi-page-actions right">
            <button class="cbi-button cbi-button-apply" id="btn-start"><%:Start%></button>
            <button class="cbi-button cbi-button-reset" id="btn-stop"><%:Stop%></button>
            <button class="cbi-button cbi-button-save" id="btn-restart"><%:Restart%></button>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:System Information%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Active Connections%>:</label>
            <div class="cbi-value-field">
                <span id="active-connections">-</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Log File Size%>:</label>
            <div class="cbi-value-field">
                <span id="log-size">-</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Uptime%>:</label>
            <div class="cbi-value-field">
                <span id="service-uptime">-</span>
            </div>
        </div>
    </fieldset>
    
    <div class="cbi-page-actions">
        <a class="cbi-button cbi-button-action" href="<%=url("admin/services/network-audit/settings")%>"><%:Go to Settings%></a>
        <a class="cbi-button" href="<%=url("admin/services/network-audit/logs")%>"><%:View Logs%></a>
        <a class="cbi-button" href="<%=url("admin/services/network-audit/rules")%>"><%:View Rules%></a>
    </div>
</div>

<script type="text/javascript">
    //<![CDATA[
    function updateStatus() {
        XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/status")%>', null,
            function(x, data) {
                if (data) {
                    try {
                        var status = JSON.parse(data);
                        var statusLabel = document.getElementById('service-status');
                        var enabledSpan = document.getElementById('service-enabled');
                        
                        if (status.running) {
                            statusLabel.innerHTML = '<span style="color: green"><%:Running%></span>';
                        } else {
                            statusLabel.innerHTML = '<span style="color: red"><%:Stopped%></span>';
                        }
                        
                        enabledSpan.innerHTML = status.enabled ? '<%:Yes%>' : '<%:No%>';
                        if (status.uptime) {
                            document.getElementById('service-uptime').innerHTML = status.uptime;
                        }
                    } catch(e) {
                        console.error('Failed to parse status:', e);
                    }
                }
            }
        );
        
        // Update system info
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'conntrack',
                    params: ['-L', '-n']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    if (resp && resp.result) {
                        var lines = resp.result.split('\\n').filter(function(line) {
                            return line.trim().length > 0;
                        });
                        document.getElementById('active-connections').innerHTML = lines.length;
                    }
                } catch(e) {
                    console.error('Failed to parse connections:', e);
                }
            }
        });
        
        // Get log file size
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'stat',
                    params: ['-c', '%s', '/var/log/network-audit.log']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    if (resp && resp.result) {
                        var size = parseInt(resp.result);
                        if (!isNaN(size)) {
                            var sizeKB = Math.round(size / 1024);
                            document.getElementById('log-size').innerHTML = sizeKB + ' KB';
                        }
                    }
                } catch(e) {
                    console.error('Failed to parse log size:', e);
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        updateStatus();
        var updateInterval = setInterval(updateStatus, 5000);
        
        document.getElementById('btn-start').addEventListener('click', function() {
            XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/start")%>', null, function() {
                setTimeout(updateStatus, 1000);
            });
        });
        
        document.getElementById('btn-stop').addEventListener('click', function() {
            XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/stop")%>', null, function() {
                setTimeout(updateStatus, 1000);
            });
        });
        
        document.getElementById('btn-restart').addEventListener('click', function() {
            XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/restart")%>', null, function() {
                setTimeout(updateStatus, 1000);
            });
        });
        
        // Clean up interval on page unload
        window.addEventListener('beforeunload', function() {
            clearInterval(updateInterval);
        });
    });
    //]]>
</script>

<%+footer%>
