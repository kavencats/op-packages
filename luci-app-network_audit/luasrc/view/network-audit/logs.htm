<%+header%>

<div class="cbi-map" id="cbi-network-audit-logs">
    <h2 name="content"><%:Network Audit Logs%></h2>
    
    <div class="cbi-map-descr">
        <p><%:View network audit logs and monitoring information.%></p>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:Log Viewer%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Log File%>:</label>
            <div class="cbi-value-field">
                <code>/var/log/network-audit.log</code>
            </div>
        </div>
        
        <div class="cbi-section-node">
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <textarea id="log-content" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; white-space: pre; overflow-x: auto;" readonly="readonly"></textarea>
                </div>
            </div>
        </div>
        
        <div class="cbi-page-actions right">
            <button class="cbi-button cbi-button-reload" id="btn-refresh"><%:Refresh%></button>
            <button class="cbi-button cbi-button-reset" id="btn-clear"><%:Clear Logs%></button>
            <button class="cbi-button cbi-button-download" id="btn-download"><%:Download%></button>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:Connection Monitor%></legend>
        <div class="cbi-section-node">
            <div class="table" style="width: 100%">
                <div class="tr table-titles">
                    <div class="th" style="width: 20%"><%:Protocol%></div>
                    <div class="th" style="width: 20%"><%:Source%></div>
                    <div class="th" style="width: 20%"><%:Destination%></div>
                    <div class="th" style="width: 20%"><%:State%></div>
                    <div class="th" style="width: 20%"><%:Age%></div>
                </div>
                <div id="connections-list" class="tbody">
                    <div class="tr">
                        <div class="td" colspan="5" style="text-align: center"><%:Loading...%></div>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
</div>

<script type="text/javascript">
    //<![CDATA[
    function refreshLogs() {
        XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/get_logs")%>', null,
            function(x, data) {
                var logTextarea = document.getElementById('log-content');
                if (logTextarea && data) {
                    logTextarea.value = data;
                    logTextarea.scrollTop = logTextarea.scrollHeight;
                }
            }
        );
        
        // Refresh connections
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'conntrack',
                    params: ['-L', '-n']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    var connectionsList = document.getElementById('connections-list');
                    if (connectionsList && resp && resp.result) {
                        var lines = resp.result.split('\\n');
                        var html = '';
                        var count = 0;
                        
                        for (var i = 0; i < lines.length && count < 10; i++) {
                            var line = lines[i].trim();
                            if (line && line.includes('ESTABLISHED')) {
                                var parts = line.split(/\s+/);
                                if (parts.length >= 6) {
                                    html += '<div class="tr">' +
                                        '<div class="td">' + (parts[0] || '-') + '</div>' +
                                        '<div class="td">' + (parts[3] || '-') + '</div>' +
                                        '<div class="td">' + (parts[5] || '-') + '</div>' +
                                        '<div class="td">ESTABLISHED</div>' +
                                        '<div class="td">-</div>' +
                                    '</div>';
                                    count++;
                                }
                            }
                        }
                        
                        if (html === '') {
                            html = '<div class="tr"><div class="td" colspan="5" style="text-align: center"><%:No active connections found%></div></div>';
                        }
                        
                        connectionsList.innerHTML = html;
                    }
                } catch(e) {
                    console.error('Failed to parse connections:', e);
                }
            }
        });
    }
    
    function clearLogs() {
        if (confirm('<%:Are you sure you want to clear all logs?%>')) {
            XHR.get('<%=luci.dispatcher.build_url("admin/services/network-audit/clear_logs")%>', null,
                function() {
                    refreshLogs();
                }
            );
        }
    }
    
    function downloadLogs() {
        var logContent = document.getElementById('log-content').value;
        if (!logContent || logContent.trim() === '') {
            alert('<%:No log content to download%>');
            return;
        }
        
        var blob = new Blob([logContent], {type: 'text/plain;charset=utf-8'});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'network-audit-' + new Date().toISOString().slice(0, 10) + '.log';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        refreshLogs();
        
        document.getElementById('btn-refresh').addEventListener('click', refreshLogs);
        document.getElementById('btn-clear').addEventListener('click', clearLogs);
        document.getElementById('btn-download').addEventListener('click', downloadLogs);
        
        var refreshInterval = setInterval(refreshLogs, 10000);
        
        window.addEventListener('beforeunload', function() {
            clearInterval(refreshInterval);
        });
    });
    //]]>
</script>

<%+footer%>
