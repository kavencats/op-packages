<%+header%>

<div class="cbi-map" id="cbi-network-audit-logs">
    <h2 name="content"><%:Network Audit Logs%></h2>
    
    <div class="cbi-map-descr">
        <p><%:View network audit logs and monitoring information.%></p>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:Log Viewer%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Log File%>:</label>
            <div class="cbi-value-field">
                <code>/var/log/network-audit.log</code>
            </div>
        </div>
        
        <div class="cbi-section-node">
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <textarea id="log-content" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px;" readonly="readonly" wrap="off"></textarea>
                </div>
            </div>
        </div>
        
        <div class="cbi-page-actions right">
            <button class="cbi-button cbi-button-reload" id="btn-refresh"><%:Refresh%></button>
            <button class="cbi-button cbi-button-reset" id="btn-clear"><%:Clear Logs%></button>
            <button class="cbi-button cbi-button-download" id="btn-download"><%:Download%></button>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:Recent Connections%></legend>
        <div class="cbi-section-node">
            <div class="table" style="width: 100%">
                <div class="tr table-titles">
                    <div class="th" style="width: 20%"><%:Protocol%></div>
                    <div class="th" style="width: 20%"><%:Source%></div>
                    <div class="th" style="width: 20%"><%:Destination%></div>
                    <div class="th" style="width: 20%"><%:State%></div>
                    <div class="th" style="width: 20%"><%:Time%></div>
                </div>
                <div id="connections-list" class="tbody">
                    <!-- Connections will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </fieldset>
</div>

<script type="text/javascript">
    //<![CDATA[
    function refreshLogs() {
        XHR.get('<%=url("admin/services/network-audit/get_logs")%>', null,
            function(x, data) {
                var logTextarea = document.getElementById('log-content');
                if (logTextarea && data) {
                    logTextarea.value = data;
                    logTextarea.scrollTop = logTextarea.scrollHeight;
                }
            }
        );
        
        // Refresh connections
        XHR.post('/cgi-bin/luci/admin/ubus', {
            json: JSON.stringify({
                jsonrpc: '2.0',
                method: 'call',
                params: [
                    '00000000000000000000000000000000',
                    'file',
                    'exec',
                    {
                        command: 'conntrack',
                        params: ['-L', '-n', '-o', 'extended']
                    }
                ]
            })
        }, function(x, data) {
            if (data) {
                var resp = JSON.parse(data);
                var connectionsList = document.getElementById('connections-list');
                if (resp.result && resp.result[1] && resp.result[1].stdout && connectionsList) {
                    var lines = resp.result[1].stdout.split('\n').slice(0, 20);
                    var html = '';
                    
                    lines.forEach(function(line) {
                        if (line.trim()) {
                            var parts = line.split(/\s+/);
                            if (parts.length >= 10) {
                                html += '<div class="tr">' +
                                    '<div class="td">' + (parts[0] || '-') + '</div>' +
                                    '<div class="td">' + (parts[3] || '-') + '</div>' +
                                    '<div class="td">' + (parts[5] || '-') + '</div>' +
                                    '<div class="td">' + (parts[9] || '-') + '</div>' +
                                    '<div class="td">' + (new Date().toLocaleTimeString()) + '</div>' +
                                '</div>';
                            }
                        }
                    });
                    
                    connectionsList.innerHTML = html || '<div class="tr"><div class="td" colspan="5"><%:No connections found%></div></div>';
                }
            }
        });
    }
    
    function clearLogs() {
        if (confirm('<%:Are you sure you want to clear all logs?%>')) {
            XHR.get('<%=url("admin/services/network-audit/clear_logs")%>', null,
                function() {
                    refreshLogs();
                }
            );
        }
    }
    
    function downloadLogs() {
        var logContent = document.getElementById('log-content').value;
        var blob = new Blob([logContent], {type: 'text/plain'});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'network-audit-' + new Date().toISOString().split('T')[0] + '.log';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        refreshLogs();
        
        document.getElementById('btn-refresh').addEventListener('click', refreshLogs);
        document.getElementById('btn-clear').addEventListener('click', clearLogs);
        document.getElementById('btn-download').addEventListener('click', downloadLogs);
        
        // Auto-refresh every 10 seconds
        setInterval(refreshLogs, 10000);
    });
    //]]>
</script>

<%+footer%>
