<%+header%>

<div class="cbi-map" id="cbi-network-audit-rules">
    <h2 name="content"><%:Network Audit Rules%></h2>
    
    <div class="cbi-map-descr">
        <p><%:View and manage current network audit rules and iptables chains.%></p>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:Active Rules%></legend>
        <div class="cbi-section-node">
            <div class="cbi-value">
                <label class="cbi-value-title"><%:IPTables Chains%>:</label>
                <div class="cbi-value-field">
                    <button class="cbi-button cbi-button-reload" id="btn-refresh-rules"><%:Refresh Rules%></button>
                </div>
            </div>
            
            <div class="cbi-value">
                <div class="cbi-value-field">
                    <ul class="cbi-tabmenu">
                        <li class="cbi-tab active" id="tab-input"><a href="javascript:void(0)" onclick="switchTab(\'input\')"><%:INPUT Chain%></a></li>
                        <li class="cbi-tab" id="tab-forward"><a href="javascript:void(0)" onclick="switchTab(\'forward\')"><%:FORWARD Chain%></a></li>
                        <li class="cbi-tab" id="tab-output"><a href="javascript:void(0)" onclick="switchTab(\'output\')"><%:OUTPUT Chain%></a></li>
                    </ul>
                    
                    <div class="cbi-tabcontent" id="tab-content-input">
                        <pre id="input-rules-content" style="background: #f5f5f5; padding: 10px; border: 1px solid #ddd; overflow: auto; max-height: 300px; font-family: monospace; font-size: 12px;"><%:Loading...%></pre>
                    </div>
                    
                    <div class="cbi-tabcontent" id="tab-content-forward" style="display: none">
                        <pre id="forward-rules-content" style="background: #f5f5f5; padding: 10px; border: 1px solid #ddd; overflow: auto; max-height: 300px; font-family: monospace; font-size: 12px;"><%:Loading...%></pre>
                    </div>
                    
                    <div class="cbi-tabcontent" id="tab-content-output" style="display: none">
                        <pre id="output-rules-content" style="background: #f5f5f5; padding: 10px; border: 1px solid #ddd; overflow: auto; max-height: 300px; font-family: monospace; font-size: 12px;"><%:Loading...%></pre>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:Connection Statistics%></legend>
        <div class="cbi-section-node">
            <div class="cbi-value">
                <label class="cbi-value-title"><%:Total Connections%>:</label>
                <div class="cbi-value-field">
                    <span id="total-connections">-</span>
                </div>
            </div>
            <div class="cbi-value">
                <label class="cbi-value-title"><%:TCP Connections%>:</label>
                <div class="cbi-value-field">
                    <span id="tcp-connections">-</span>
                </div>
            </div>
            <div class="cbi-value">
                <label class="cbi-value-title"><%:UDP Connections%>:</label>
                <div class="cbi-value-field">
                    <span id="udp-connections">-</span>
                </div>
            </div>
            <div class="cbi-value">
                <label class="cbi-value-title"><%:Rules Count%>:</label>
                <div class="cbi-value-field">
                    <span id="rules-count">-</span>
                </div>
            </div>
        </div>
    </fieldset>
</div>

<script type="text/javascript">
    //<![CDATA[
    function switchTab(tabName) {
        // Hide all tabs
        document.getElementById('tab-content-input').style.display = 'none';
        document.getElementById('tab-content-forward').style.display = 'none';
        document.getElementById('tab-content-output').style.display = 'none';
        
        // Remove active class from all tabs
        document.getElementById('tab-input').className = 'cbi-tab';
        document.getElementById('tab-forward').className = 'cbi-tab';
        document.getElementById('tab-output').className = 'cbi-tab';
        
        // Show selected tab
        document.getElementById('tab-content-' + tabName).style.display = 'block';
        document.getElementById('tab-' + tabName).className = 'cbi-tab active';
    }
    
    function refreshRules() {
        // Get INPUT chain rules
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'iptables',
                    params: ['-L', 'NETWORK_AUDIT_INPUT', '-vn', '--line-numbers']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    var content = document.getElementById('input-rules-content');
                    if (content && resp && resp.result) {
                        content.textContent = resp.result || '<%:No rules found%>';
                    }
                } catch(e) {
                    console.error('Failed to parse INPUT rules:', e);
                }
            }
        });
        
        // Get FORWARD chain rules
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'iptables',
                    params: ['-L', 'NETWORK_AUDIT_FORWARD', '-vn', '--line-numbers']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    var content = document.getElementById('forward-rules-content');
                    if (content && resp && resp.result) {
                        content.textContent = resp.result || '<%:No rules found%>';
                    }
                } catch(e) {
                    console.error('Failed to parse FORWARD rules:', e);
                }
            }
        });
        
        // Get OUTPUT chain rules
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'iptables',
                    params: ['-L', 'NETWORK_AUDIT_OUTPUT', '-vn', '--line-numbers']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    var content = document.getElementById('output-rules-content');
                    if (content && resp && resp.result) {
                        content.textContent = resp.result || '<%:No rules found%>';
                    }
                } catch(e) {
                    console.error('Failed to parse OUTPUT rules:', e);
                }
            }
        });
        
        // Get connection statistics
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'conntrack',
                    params: ['-L', '-n']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    if (resp && resp.result) {
                        var output = resp.result;
                        var lines = output.split('\\n').filter(function(line) {
                            return line.trim().length > 0;
                        });
                        
                        var total = lines.length;
                        var tcp = 0;
                        var udp = 0;
                        
                        lines.forEach(function(line) {
                            if (line.includes('tcp')) tcp++;
                            if (line.includes('udp')) udp++;
                        });
                        
                        document.getElementById('total-connections').textContent = total;
                        document.getElementById('tcp-connections').textContent = tcp;
                        document.getElementById('udp-connections').textContent = udp;
                    }
                } catch(e) {
                    console.error('Failed to parse connections:', e);
                }
            }
        });
        
        // Count total rules
        XHR.post('/cgi-bin/luci/rpc/uci', {
            json: JSON.stringify({
                method: 'exec',
                params: {
                    command: 'sh',
                    params: ['-c', 'iptables -L NETWORK_AUDIT_INPUT -n 2>/dev/null | wc -l; iptables -L NETWORK_AUDIT_FORWARD -n 2>/dev/null | wc -l; iptables -L NETWORK_AUDIT_OUTPUT -n 2>/dev/null | wc -l']
                }
            })
        }, function(x, data) {
            if (data) {
                try {
                    var resp = JSON.parse(data);
                    if (resp && resp.result) {
                        var counts = resp.result.split('\\n').map(Number).filter(function(n) {
                            return !isNaN(n);
                        });
                        var total = counts.reduce(function(a, b) { return a + b; }, 0) - 3; // Subtract chain headers
                        document.getElementById('rules-count').textContent = Math.max(0, total);
                    }
                } catch(e) {
                    console.error('Failed to parse rules count:', e);
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        refreshRules();
        
        document.getElementById('btn-refresh-rules').addEventListener('click', refreshRules);
        
        var refreshInterval = setInterval(refreshRules, 30000);
        
        window.addEventListener('beforeunload', function() {
            clearInterval(refreshInterval);
        });
    });
    
    // Initialize with INPUT tab active
    window.onload = function() {
        switchTab('input');
    };
    //]]>
</script>

<%+footer%>
