<%+header%>
<div class="cbi-map" id="cbi-network-audit">
    <h2 name="content"><%:Network Audit - Real-time Status%></h2>
    <div class="cbi-map-descr"><%:Real-time network monitoring and status information%></div>
    
    <div class="cbi-section">
        <h3><%:System Status%></h3>
        <div class="table" id="status-table">
            <div class="tr">
                <div class="td left" style="width: 200px"><%:Audit Service%>:</div>
                <div class="td" id="service-status">-</div>
            </div>
            <div class="tr">
                <div class="td left"><%:Active Connections%>:</div>
                <div class="td" id="connection-count">-</div>
            </div>
            <div class="tr">
                <div class="td left"><%:Total Bandwidth (RX/TX)%>:</div>
                <div class="td" id="bandwidth-total">-</div>
            </div>
            <div class="tr">
                <div class="td left"><%:Blocked Today%>:</div>
                <div class="td" id="blocked-count">-</div>
            </div>
        </div>
    </div>
    
    <div class="cbi-section">
        <h3><%:Interface Traffic%></h3>
        <div class="table" id="traffic-table">
            <div class="tr table-titles">
                <div class="th" style="width: 100px"><%:Interface%></div>
                <div class="th" style="width: 150px"><%:Received%></div>
                <div class="th" style="width: 150px"><%:Transmitted%></div>
                <div class="th" style="width: 150px"><%:Total%></div>
            </div>
        </div>
    </div>
    
    <div class="cbi-section">
        <h3><%:Active Connections%> <span class="cbi-badge" id="conn-count-badge">0</span></h3>
        <div class="table" id="connections-table" style="max-height: 300px; overflow-y: auto">
            <div class="tr table-titles">
                <div class="th" style="width: 100px"><%:Source%></div>
                <div class="th" style="width: 100px"><%:Dest%></div>
                <div class="th" style="width: 80px"><%:Protocol%></div>
                <div class="th" style="width: 100px"><%:State%></div>
                <div class="th" style="width: 100px"><%:Bytes%></div>
            </div>
        </div>
    </div>
    
    <div class="cbi-section">
        <div class="cbi-value">
            <label class="cbi-label"><%:Auto Refresh%></label>
            <div class="cbi-value-field">
                <input type="checkbox" id="auto-refresh" checked="checked" />
                <label for="auto-refresh"><%:Enabled%> (5s)</label>
            </div>
        </div>
    </div>
</div>

<script>
    function formatBytes(bytes) {
        if (bytes == 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function updateStatus() {
        XHR.get('<%=url("admin/services/network-audit/get_status")%>', null,
            function(x, data) {
                if (data) {
                    var status = JSON.parse(data);
                    document.getElementById('service-status').textContent = 
                        status.enabled == '1' ? '<%:Running%>' : '<%:Stopped%>';
                    document.getElementById('connection-count').textContent = 
                        status.connections;
                    document.getElementById('bandwidth-total').textContent = 
                        formatBytes(status.bandwidth.rx) + ' / ' + formatBytes(status.bandwidth.tx);
                    document.getElementById('blocked-count').textContent = 
                        status.blocked;
                }
            }
        );
    }
    
    function updateTraffic() {
        XHR.get('<%=url("admin/services/network-audit/get_traffic_stats")%>', null,
            function(x, data) {
                if (data) {
                    var traffic = JSON.parse(data);
                    var table = document.getElementById('traffic-table');
                    // 清空旧行，保留表头
                    while (table.rows.length > 1) {
                        table.deleteRow(1);
                    }
                    
                    for (var iface in traffic) {
                        var row = table.insertRow(-1);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        
                        cell1.textContent = iface;
                        cell2.textContent = formatBytes(traffic[iface].rx);
                        cell3.textContent = formatBytes(traffic[iface].tx);
                        cell4.textContent = formatBytes(traffic[iface].rx + traffic[iface].tx);
                    }
                }
            }
        );
    }
    
    function updateConnections() {
        XHR.get('<%=url("admin/services/network-audit/get_connections")%>', null,
            function(x, data) {
                if (data) {
                    var connections = JSON.parse(data);
                    var table = document.getElementById('connections-table');
                    var badge = document.getElementById('conn-count-badge');
                    
                    badge.textContent = connections.length;
                    
                    // 清空旧行，保留表头
                    while (table.rows.length > 1) {
                        table.deleteRow(1);
                    }
                    
                    connections.slice(0, 50).forEach(function(conn) {
                        var row = table.insertRow(-1);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        var cell5 = row.insertCell(4);
                        
                        cell1.textContent = conn.src + ':' + conn.sport;
                        cell2.textContent = conn.dst + ':' + conn.dport;
                        cell3.textContent = conn.proto;
                        cell4.textContent = conn.state;
                        cell5.textContent = formatBytes(conn.bytes);
                    });
                }
            }
        );
    }
    
    function refreshAll() {
        updateStatus();
        updateTraffic();
        updateConnections();
    }
    
    // 初始加载
    refreshAll();
    
    // 设置自动刷新
    var refreshInterval = null;
    var autoRefresh = document.getElementById('auto-refresh');
    
    function toggleAutoRefresh() {
        if (autoRefresh.checked) {
            refreshInterval = setInterval(refreshAll, 5000);
        } else {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    }
    
    autoRefresh.addEventListener('change', toggleAutoRefresh);
    toggleAutoRefresh(); // 初始启动
</script>
<%+footer%>