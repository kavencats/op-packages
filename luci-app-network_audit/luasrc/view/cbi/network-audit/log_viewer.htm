<%+header%>
<div class="cbi-map">
    <div class="cbi-section">
        <h3><%:Audit Log Viewer%></h3>
        <div class="cbi-value">
            <label class="cbi-label"><%:Log File%></label>
            <div class="cbi-value-field">
                <code>/var/log/network-audit.log</code>
                <button class="cbi-button cbi-button-action" onclick="clearLogs()"><%:Clear Logs%></button>
            </div>
        </div>
        
        <div class="cbi-value">
            <label class="cbi-label"><%:Log Content%></label>
            <div class="cbi-value-field">
                <div style="width: 100%;">
                    <textarea id="log-content" style="width: 100%; height: 300px; font-family: monospace; background: #f5f5f5; border: 1px solid #ccc; padding: 5px; white-space: pre; overflow: auto;" readonly="readonly" wrap="off">
<%
local fs = require "nixio.fs"
local logfile = "/var/log/network-audit.log"
if fs.access(logfile) then
    local f = io.open(logfile, "r")
    if f then
        local content = f:read("*a")
        f:close()
        if #content > 0 then
            write(luci.util.pcdata(content))
        else
            write(translate("Log file is empty."))
        end
    else
        write(translate("Cannot read log file."))
    end
else
    write(translate("Log file does not exist."))
end
%>
                    </textarea>
                </div>
            </div>
        </div>
        
        <div class="cbi-value">
            <div class="cbi-value-field">
                <button class="cbi-button cbi-button-reload" onclick="refreshLogs()"><%:Refresh%></button>
                <button class="cbi-button" onclick="downloadLogs()"><%:Download%></button>
            </div>
        </div>
    </div>
</div>

<script>
    function refreshLogs() {
        XHR.get('<%=url("admin/services/network-audit/clear_logs")%>?read=1', null, 
            function(x, data) {
                if (x.status == 200) {
                    var result = JSON.parse(data);
                    if (result && result.logs) {
                        document.getElementById('log-content').value = result.logs;
                    } else {
                        // 如果返回不是JSON，直接使用返回内容
                        document.getElementById('log-content').value = data;
                    }
                } else {
                    // 回退到重新加载页面
                    window.location.reload();
                }
            }
        );
    }
    
    function clearLogs() {
        if (confirm('<%:Are you sure you want to clear all audit logs?%>')) {
            XHR.get('<%=url("admin/services/network-audit/clear_logs")%>', null,
                function(x, data) {
                    if (x.status == 200) {
                        alert('<%:Logs cleared successfully.%>');
                        refreshLogs();
                    } else {
                        alert('<%:Failed to clear logs.%>');
                    }
                }
            );
        }
    }
    
    function downloadLogs() {
        var content = document.getElementById('log-content').value;
        var blob = new Blob([content], {type: 'text/plain'});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'network-audit-' + new Date().toISOString().slice(0,10) + '.log';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    // 自动刷新日志
    setInterval(refreshLogs, 10000);
</script>
<%+footer%>