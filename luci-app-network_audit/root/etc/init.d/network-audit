#!/bin/sh
# Copyright (C) 2024 Your Name
# Network Audit Service

USE_PROCD=1
START=99
STOP=10
EXTRA_COMMANDS="cleanup"
EXTRA_HELP="  cleanup  Clean up iptables rules and temporary files"

SERVICE_NAME="network-audit"
SERVICE_DAEMON="/usr/share/network-audit/scripts/audit.sh"
SERVICE_PID_FILE="/var/run/network-audit.pid"
SERVICE_LOG_FILE="/var/log/network-audit.log"
CONFIG_FILE="/etc/config/network-audit"

validate_config() {
    uci -q get "network-audit.@general[0]" >/dev/null || {
        logger -t network-audit "Configuration validation failed"
        return 1
    }
    return 0
}

service_triggers() {
    procd_add_reload_trigger "network-audit"
    procd_add_validation validate_config
}

cleanup_iptables() {
    # 清理 iptables 规则
    iptables -D INPUT -j NETWORK_AUDIT_INPUT 2>/dev/null
    iptables -D FORWARD -j NETWORK_AUDIT_FORWARD 2>/dev/null
    iptables -D OUTPUT -j NETWORK_AUDIT_OUTPUT 2>/dev/null
    
    iptables -F NETWORK_AUDIT_INPUT 2>/dev/null
    iptables -F NETWORK_AUDIT_FORWARD 2>/dev/null
    iptables -F NETWORK_AUDIT_OUTPUT 2>/dev/null
    
    iptables -X NETWORK_AUDIT_INPUT 2>/dev/null
    iptables -X NETWORK_AUDIT_FORWARD 2>/dev/null
    iptables -X NETWORK_AUDIT_OUTPUT 2>/dev/null
    
    logger -t network-audit "IPTables rules cleaned up"
}

start_service() {
    [ ! -x "$SERVICE_DAEMON" ] && {
        logger -t network-audit "Service executable not found: $SERVICE_DAEMON"
        return 1
    }
    
    procd_open_instance
    procd_set_param command "$SERVICE_DAEMON"
    procd_set_param respawn
    procd_set_param respawn_threshold 3600
    procd_set_param respawn_timeout 5
    procd_set_param respawn_retry 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "$SERVICE_PID_FILE"
    procd_set_param file "$CONFIG_FILE"
    procd_close_instance
    
    logger -t network-audit "Service started"
    return 0
}

stop_service() {
    if [ -f "$SERVICE_PID_FILE" ]; then
        local pid=$(cat "$SERVICE_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill -TERM "$pid" 2>/dev/null
            sleep 2
            if kill -0 "$pid" 2>/dev/null; then
                kill -KILL "$pid" 2>/dev/null
            fi
        fi
        rm -f "$SERVICE_PID_FILE"
    fi
    logger -t network-audit "Service stopped"
    return 0
}

cleanup() {
    echo "Cleaning up network-audit service..."
    
    # 停止服务
    stop_service
    
    # 清理 iptables
    cleanup_iptables
    
    # 清理运行时文件
    rm -f /var/run/network-audit.pid
    rm -rf /var/run/network-audit
    
    # 清理日志文件
    echo "Clearing log file..."
    > /var/log/network-audit.log 2>/dev/null
    
    # 禁用服务
    rm -f /etc/rc.d/*network-audit 2>/dev/null
    
    echo "Cleanup completed"
    return 0
}

status() {
    if [ -f "$SERVICE_PID_FILE" ] && kill -0 $(cat "$SERVICE_PID_FILE") 2>/dev/null; then
        echo "running"
        return 0
    else
        echo "stopped"
        return 1
    fi
}
