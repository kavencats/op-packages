#!/bin/sh

. /usr/share/libubox/jshn.sh

COMMAND="$1"

case "$COMMAND" in
    get_status)
        json_init
        json_add_string "service" "$(service network-audit status)"
        json_add_int "connections" $(conntrack -L 2>/dev/null | wc -l)
        json_add_string "timestamp" "$(date '+%Y-%m-%d %H:%M:%S')"
        json_dump
        ;;
    
    get_traffic)
        json_init
        # 获取接口流量
        for iface in $(ls /sys/class/net/ | grep -v lo); do
            rx=$(cat /sys/class/net/$iface/statistics/rx_bytes 2>/dev/null || echo 0)
            tx=$(cat /sys/class/net/$iface/statistics/tx_bytes 2>/dev/null || echo 0)
            json_add_object "$iface"
            json_add_int "rx" "$rx"
            json_add_int "tx" "$tx"
            json_close_object
        done
        json_dump
        ;;
    
    get_connections)
        json_init
        json_add_array "connections"
        conntrack -L 2>/dev/null | while read line; do
            if echo "$line" | grep -q "tcp\|udp"; then
                json_add_object
                json_add_string "line" "$line"
                json_close_object
            fi
        done
        json_close_array
        json_dump
        ;;
    
    clear_logs)
        echo "" > /var/log/network-audit.log
        json_init
        json_add_boolean "success" 1
        json_dump
        ;;
    
    *)
        echo '{"error": "Unknown command"}'
        ;;
esac