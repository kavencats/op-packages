name: Build OpenAppFilter for OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: destan19/OpenAppFilter
          ref: main

      - name: Setup OpenWrt SDK
        uses: actions/setup-openwrt-sdk@v1
        with:
          sdk-version: '25.12-rc2'
          target: 'aarch64_cortex-a53'
          arch: 'aarch64'
          toolchain: 'gcc-13.2.1'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses5-dev zlib1g-dev gawk flex quilt git-lfs

      - name: Configure Build
        run: |
          make defconfig
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          echo "CONFIG_PACKAGE_kmod-oaf=y" >> .config

      - name: Compile Plugins
        run: |
          make package/luci-app-oaf/compile V=s
          make package/kmod-oaf/compile V=s

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6.0.0
        with:
          name: openappfilter-apks
          path: |
            bin/packages/aarch64_cortex-a53/base/luci-app-oaf_*.apk
            bin/packages/aarch64_cortex-a53/kernel/kmod-oaf_*.apk
